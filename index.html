<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ê¸‰ì‹ë¹„ ê³„ì‚°ê¸° (ë°ì´í„° íƒ€ì… ë³´ì •íŒ)</title>
    <script src="https://cdn.sheetjs.com/xlsx-latest/package/dist/xlsx.full.min.js"></script>
    <style>
        body { font-family: 'Malgun Gothic', sans-serif; max-width: 800px; margin: 20px auto; padding: 20px; line-height: 1.6; color: #333; background-color: #f4f7f6; }
        .container { background: white; padding: 30px; border-radius: 12px; box-shadow: 0 4px 6px rgba(0,0,0,0.1); }
        h1 { color: #2c3e50; text-align: center; margin-bottom: 30px; }
        .section { margin-bottom: 25px; padding: 15px; border: 1px solid #eee; border-radius: 8px; }
        .section-title { font-weight: bold; margin-bottom: 10px; color: #007bff; display: block; }
        .input-group { display: grid; grid-template-columns: 1fr 1fr; gap: 15px; margin-bottom: 10px; }
        label { display: block; font-size: 0.9em; margin-bottom: 5px; color: #666; }
        input[type="text"], input[type="number"] { width: 100%; padding: 8px; border: 1px solid #ddd; border-radius: 4px; box-sizing: border-box; }
        .button-group { display: flex; gap: 10px; margin-top: 20px; }
        button { flex: 1; padding: 12px; border: none; border-radius: 6px; cursor: pointer; font-weight: bold; transition: 0.3s; }
        .btn-primary { background-color: #007bff; color: white; }
        .btn-primary:hover { background-color: #0056b3; }
        .btn-secondary { background-color: #6c757d; color: white; }
        #status { margin-top: 15px; text-align: center; font-weight: bold; }
    </style>
</head>
<body>

<div class="container">
    <h1>ê¸‰ì‹ë¹„ ê³„ì‚°ê¸°</h1>
    <p style="text-align: center; color: #27ae60; font-size: 0.9em;">ğŸ”¢ ìˆ˜ë‹¹ì‹œê°„(ë¶„) ë° No. ì»¬ëŸ¼ì´ ìˆ«ì í˜•ì‹ìœ¼ë¡œ ì €ì¥ë©ë‹ˆë‹¤.</p>

    <div class="section">
        <span class="section-title">1. ì—‘ì…€ íŒŒì¼ ì„ íƒ</span>
        <input type="file" id="excelFile" accept=".xlsx, .xls">
    </div>

    <div class="section">
        <span class="section-title">2. ê¸°ë³¸ ì„¤ì •</span>
        <div class="input-group">
            <div><label>ê¸‰ì‹ë¹„ ë‹¨ê°€ (ì›)</label><input type="number" id="unitPrice" value="9000"></div>
            <div><label>íœ´ì¼ ìµœì†Œ ê·¼ë¬´ì‹œê°„ (ë¶„)</label><input type="number" id="minHours" value="60"></div>
        </div>
    </div>

    <div class="section">
        <span class="section-title">3. íœ´ì¼ ì œì™¸ ì‹œê°„ [HH:mm(24ì‹œê°„ì œ) í˜•ì‹ìœ¼ë¡œ ì…ë ¥]</span>
        <div class="input-group">
            <div><label>ë¯¸ì§€ê¸‰ ì‹œê°„ 1 ì‹œì‘</label><input type="text" id="s1" value="09:00"></div>
            <div><label>ë¯¸ì§€ê¸‰ ì‹œê°„ 1 ì¢…ë£Œ</label><input type="text" id="e1" value="12:00"></div>
        </div>
        <div class="input-group">
            <div><label>ë¯¸ì§€ê¸‰ ì‹œê°„ 2 ì‹œì‘</label><input type="text" id="s2" value="13:00"></div>
            <div><label>ë¯¸ì§€ê¸‰ ì‹œê°„ 2 ì¢…ë£Œ</label><input type="text" id="e2" value="18:00"></div>
        </div>
        <div class="input-group">
            <div style="grid-column: span 2;">
                <label>ë¯¸ì§€ê¸‰ ì‹œê°„ 3 ì‹œì‘ (ì´í›„ ë¯¸ì§€ê¸‰)</label>
                <input type="text" id="s3" value="19:00">
            </div>
        </div>
    </div>

    <div class="button-group">
        <button class="btn-primary" onclick="processExcel()">ê³„ì‚° ë° ê²°ê³¼ ë‹¤ìš´ë¡œë“œ</button>
        <button class="btn-secondary" onclick="location.reload()">ì´ˆê¸°í™”</button>
    </div>

    <div id="status"></div>
</div>

<script>
    function timeToVal(timeStr) {
        if (!timeStr) return null;
        return timeStr.replace(/:/g, '').trim().substring(0, 4);
    }

    async function processExcel() {
        const fileInput = document.getElementById('excelFile');
        const status = document.getElementById('status');
        if (!fileInput.files[0]) { alert('íŒŒì¼ì„ ì„ íƒí•´ì£¼ì„¸ìš”.'); return; }

        status.innerText = "ë°ì´í„° ì²˜ë¦¬ ì¤‘...";
        const file = fileInput.files[0];
        const reader = new FileReader();

        reader.onload = function(e) {
            try {
                const data = new Uint8Array(e.target.result);
                const workbook = XLSX.read(data, { type: 'array', cellDates: true });
                const rows = XLSX.utils.sheet_to_json(workbook.Sheets[workbook.SheetNames[0]]);

                const config = {
                    unitPrice: parseInt(document.getElementById('unitPrice').value),
                    minHours: parseInt(document.getElementById('minHours').value),
                    s1: timeToVal(document.getElementById('s1').value), e1: timeToVal(document.getElementById('e1').value),
                    s2: timeToVal(document.getElementById('s2').value), e2: timeToVal(document.getElementById('e2').value),
                    s3: timeToVal(document.getElementById('s3').value)
                };

                const targetColumns = ['No.', 'ê·¼ë¬´ì¼ì', 'ë¶€ì„œ', 'ì§ê¸‰', 'ê³ ìœ ì‹ë³„ë²ˆí˜¸', 'ì„±ëª…', 'íœ´ì¼êµ¬ë¶„', 'ìë£Œêµ¬ë¶„', 'ê²°ì¬ìƒíƒœ', 'ì¶œê·¼(ì‹¤ì œ)', 'í‡´ê·¼(ì‹¤ì œ)', 'ìˆ˜ë‹¹ì‹œê°„(ë¶„)'];

                const processedData = rows
                    .filter(row => row['ìë£Œêµ¬ë¶„'] === 'ì •ì‚°' && row['ê²°ì¬ìƒíƒœ'] === 'ì²˜ë¦¬')
                    .map(row => {
                        let mealCount = 0;
                        const overtime = parseInt(row['ìˆ˜ë‹¹ì‹œê°„(ë¶„)'] || 0);
                        const isHoliday = row['íœ´ì¼êµ¬ë¶„'] === 'íœ´ì¼';
                        const start = timeToVal(row['ì¶œê·¼(ì‹¤ì œ)']);
                        const end = timeToVal(row['í‡´ê·¼(ì‹¤ì œ)']);

                        if (!isHoliday && overtime >= 60) mealCount = 1;
                        else if (isHoliday && overtime >= config.minHours) {
                            mealCount = 1;
                            if (config.s1 && config.e1 && start >= config.s1 && end <= config.e1) mealCount = 0;
                            if (config.s2 && config.e2 && start >= config.s2 && end <= config.e2) mealCount = 0;
                            if (config.s3 && start >= config.s3) mealCount = 0;
                        }

                        const res = {};
                        targetColumns.forEach(c => {
                            let val = row[c];
                            // [í•µì‹¬ ìˆ˜ì •] ìˆ«ìí˜• ì»¬ëŸ¼ì— ëŒ€í•œ ëª…ì‹œì  í˜•ë³€í™˜
                            if (c === 'ìˆ˜ë‹¹ì‹œê°„(ë¶„)' || c === 'No.') {
                                val = val ? Number(val) : 0;
                            }
                            res[c] = val;
                        });
                        
                        res['ì‹ìˆ˜'] = mealCount;
                        res['ì‹ëŒ€'] = mealCount * config.unitPrice;
                        
                        const d = new Date(row['ê·¼ë¬´ì¼ì']);
                        res['_day'] = isNaN(d.getTime()) ? null : d.getDate();
                        return res;
                    });

                // ì‹œíŠ¸ 2: ê°œì¸ë³„ í•©ê³„
                const summaryMap = new Map();
                processedData.forEach(r => {
                    const existing = summaryMap.get(r['ì„±ëª…']) || { 'ì„±ëª…': r['ì„±ëª…'], 'ì´ì‹ìˆ˜': 0, 'ì´ì‹ëŒ€': 0 };
                    existing['ì´ì‹ìˆ˜'] += r['ì‹ìˆ˜'];
                    existing['ì´ì‹ëŒ€'] += r['ì‹ëŒ€'];
                    summaryMap.set(r['ì„±ëª…'], existing);
                });

                // ì‹œíŠ¸ 3: ë‚ ì§œë³„ ì²´í¬
                const activeDaysNums = [...new Set(processedData.filter(r => r['ì‹ìˆ˜'] === 1).map(r => r['_day']))].sort((a,b) => a-b);
                const activeDaysHeaders = activeDaysNums.map(d => d + "ì¼");
                const names = [...new Set(processedData.map(r => r['ì„±ëª…']))].sort();
                
                const pivotData = names.map(name => {
                    const row = { 'ì„±ëª…': name };
                    activeDaysNums.forEach((dayNum, idx) => {
                        const hasMeal = processedData.some(r => r['ì„±ëª…'] === name && r['_day'] === dayNum && r['ì‹ìˆ˜'] === 1);
                        const headerKey = activeDaysHeaders[idx];
                        row[headerKey] = hasMeal ? dayNum : ""; 
                    });
                    return row;
                });

                const newWb = XLSX.utils.book_new();
                
                // ì‹œíŠ¸ 1: ìƒì„¸ë‚´ì—­
                const detailSheet = XLSX.utils.json_to_sheet(processedData.map(({_day, ...rest}) => rest));
                XLSX.utils.book_append_sheet(newWb, detailSheet, "ìƒì„¸ë‚´ì—­");

                // ì‹œíŠ¸ 2: ê°œì¸ë³„í•©ê³„
                XLSX.utils.book_append_sheet(newWb, XLSX.utils.json_to_sheet([...summaryMap.values()]), "ê°œì¸ë³„í•©ê³„");

                // ì‹œíŠ¸ 3: ë‚ ì§œë³„ì²´í¬
                const pivotSheet = XLSX.utils.json_to_sheet(pivotData, { header: ['ì„±ëª…', ...activeDaysHeaders] });
                XLSX.utils.book_append_sheet(newWb, pivotSheet, "ë‚ ì§œë³„ì²´í¬");

                XLSX.writeFile(newWb, `ê¸‰ì‹ë¹„ì •ì‚°_ìµœì¢…_${new Date().toISOString().slice(0,10)}.xlsx`);
                status.innerText = "í˜•ì‹ ë³´ì • ì™„ë£Œ!";
            } catch (err) {
                console.error(err);
                alert("ì²˜ë¦¬ ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤.");
            }
        };
        reader.readAsArrayBuffer(file);
    }
</script>
</body>
</html>